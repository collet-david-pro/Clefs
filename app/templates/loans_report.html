<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Gestionnaire de Clés</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    {% include 'navbar.html' %}

    <main class="container" style="padding-top: 5rem;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ page_title }}</h1>
            <button onclick="window.print()" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer" viewBox="0 0 16 16">
                    <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
                    <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
                </svg>
                Imprimer / PDF
            </button>
        </div>

        {% if active_loans %}
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        Toutes les Clés Sorties
                        <span class="badge bg-danger rounded-pill ms-2">{{ active_loans | length }} emprunt(s) actif(s)</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Clé</th>
                                <th style="width: 35%;">Description</th>
                                <th style="width: 20%;">Emprunté par</th>
                                <th style="width: 15%;">Date d'emprunt</th>
                                <th style="width: 10%;" class="text-center">Durée</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loan in active_loans %}
                            {% set days_out = (now - loan.loan_date).days %}
                            <tr>
                                <td class="align-middle">
                                    <strong>{{ loan.key.number }}</strong>
                                </td>
                                <td class="align-middle">
                                    <small class="text-muted">{{ loan.key.description }}</small>
                                </td>
                                <td class="align-middle">
                                    {{ loan.borrower.name }}
                                </td>
                                <td class="align-middle">
                                    {{ loan.loan_date.strftime('%d/%m/%Y à %H:%M') }}
                                </td>
                                <td class="align-middle text-center">
                                    {% if days_out == 0 %}
                                    <span class="badge bg-success">Aujourd'hui</span>
                                    {% elif days_out == 1 %}
                                    <span class="badge bg-info">1 jour</span>
                                    {% elif days_out < 7 %}
                                    <span class="badge bg-info">{{ days_out }} jours</span>
                                    {% elif days_out < 30 %}
                                    <span class="badge bg-warning">{{ days_out }} jours</span>
                                    {% else %}
                                    <span class="badge bg-danger">{{ days_out }} jours</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-muted">
                    <small>
                        <strong>Légende durée :</strong>
                        <span class="badge bg-success">Aujourd'hui</span>
                        <span class="badge bg-info">1-6 jours</span>
                        <span class="badge bg-warning">7-29 jours</span>
                        <span class="badge bg-danger">30+ jours</span>
                    </small>
                </div>
            </div>

            <!-- Summary by Borrower -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Résumé par Emprunteur</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% set borrowers_dict = {} %}
                        {% for loan in active_loans %}
                            {% if loan.borrower.name not in borrowers_dict %}
                                {% set _ = borrowers_dict.update({loan.borrower.name: []}) %}
                            {% endif %}
                            {% set _ = borrowers_dict[loan.borrower.name].append(loan.key.number) %}
                        {% endfor %}
                        
                        {% for borrower_name, key_numbers in borrowers_dict.items() %}
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <h6 class="mb-2">
                                    {{ borrower_name }}
                                    <span class="badge bg-primary">{{ key_numbers | length }}</span>
                                </h6>
                                <small class="text-muted">
                                    {% for key_num in key_numbers %}
                                        <span class="badge bg-secondary">{{ key_num }}</span>
                                    {% endfor %}
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        {% else %}
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-check-circle mb-3" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                    </svg>
                    <h4>Aucune clé sortie</h4>
                    <p>Toutes les clés sont actuellement disponibles.</p>
                </div>
            </div>
        {% endif %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        @media print {
            .btn, nav, .navbar {
                display: none !important;
            }
            .card {
                border: 1px solid #000 !important;
                page-break-inside: avoid;
            }
            .card-footer {
                display: none;
            }
        }
    </style>
</body>
</html>
